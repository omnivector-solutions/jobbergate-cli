#!/bin/sh
############### User defined variables #################
{%- if data.output_directory %}
# Slurm output file location
#SBATCH -o {{data.output_directory or "."}}/slurm-%j.out
{%- endif %}
# Job name
#SBATCH -J {{data.jobname or "Star-CCM+"}}
# An email is sent at state change and at 80% of given time
#SBATCH --mail-type=ALL,TIME_LIMIT_80
# Wait until following jobs have finished
{%- if data.all_dependencies %}
#SBATCH --dependency=afterany:{{ data.all_dependencies|join(":") }}
{%- else %}
##SBATCH --dependency=afterany:
{%- endif %}
# Wall-clock time: SLURM timeout [hh:mm:ss]
#SBATCH -t {{data.timelimit}}:00:00
# Number of MPI processes
#SBATCH -n {{data.cores or 108}}
{% if data.memory %}
# Memory requirement
#SBATCH --mem={{data.memory}}G
{% endif %}
{%- block sbatch %}
{%- if data.partition %}
# Run on specific partition
#SBATCH --partition {{data.partition}}
{% endif %}
# Name of account (not user) for accounting.
#SBATCH -A starccm
# Exclusive by default
#SBATCH --exclusive {%- if data.sharenode %}=user{% endif %}
{% endblock sbatch %}
{#- TODO specify hardware? --constraint #}
{# --nodelist [specific node] for sharing node?  #}
# Load STAR-CCM+ module
#. /etc/profile.d/z00_lmod.sh # TODO remove when modules are available by default on nodes
#module use /grp/techsim/fluidsim/software/Modules/modulefiles # TODO remove when modules are available by default on nodes
#module add {{data.module}}
# what is inside the directory
#
# /cluster/sesonas13/jbemfv/modules/startestmodules/data.modules
module use /cluster/sesonas13/jbemfv/modules/testmodules/starccm_modules
# Name of sim-file so start simulation from
SIM_FILE="{{data.filename}}"
# /cluster/sesonas13/sssler/startests/SteadyFlowBackwardFacingStep_final.sim
# Name of java macro to execute on given sim-file
STARTMACRO="./starccm{{data.workflow}}.java"
# Path to macro library
#STAR_CLASS_PATH="/grp/techsim/fluidsim/software/Java/poi-3.7-FINAL"
STAR_CLASS_PATH=/share/apps/poi-3.7-FINAL
# Name of log file
LOGFILE=starccm{{data.workflow}}.${SLURM_JOBID}.log
############### End of User defined variables #################
{%- block license %}
# Define license server
export CDLMD_LICENSE_FILE=27012@Licserv0001.scania.com:27012@Licserv0002.scania.com:27012@Licserv0003.scania.com:28060@caxsrv17p28060.wob.vw.vwg
{% endblock license %}
{% block execution %}
{% if data.stageup -%}
# Copy files to /cluster/...
START_DIR=$SLURM_SUBMIT_DIR
STAGE_DIR="/cluster/sesonas13/$USER/${SLURM_JOB_NAME}_$SLURM_JOBID"
echo "Staging files in $STAGE_DIR"
mkdir -p $STAGE_DIR
cp $SIM_FILE $STAGE_DIR
cp $STARTMACRO $STAGE_DIR
cd $STAGE_DIR
{%- endif %}
# Save node list to file
export NODEFILE=nodelist_$SLURM_JOB_NAME # Is the export needed?
/share/apps/hostlist/python-hostlist-1.18/hostlist --append=: --append-slurm-tasks=$SLURM_TASKS_PER_NODE -e $SLURM_JOB_NODELIST > $NODEFILE
# /grp/techsim/fluidsim/software/hostlist/python-hostlist-1.18/hostlist --append=: --append-slurm-tasks=$SLURM_TASKS_PER_NODE -e $SLURM_JOB_NODELIST > $NODEFILE
#-batch [mesh|run|step|Java macro file]: no UI
#-np # : amount of processess (/co-simulation instances?)
#-power : use power license
#EXTRA_FLAGS=""
starccm -machinefile $NODEFILE -power -np $SLURM_NTASKS -batch $STARTMACRO -classpath $STAR_CLASS_PATH
{%- if data.workflow=="Sim" %} -mpi intel -mpiflags "-bootstrap slurm" {% endif -%}
{%- if data.workflow in ["PostMeshNode","PostComputeNode"] %} -noexit{% endif %} $SIM_FILE &>> $LOGFILE
{% if data.stageup -%}
# Copy everything back, don't force it
echo "Returning files to $START_DIR"
cp * $START_DIR --no-clobber
cd $START_DIR
# Clean up
rm -r $STAGE_DIR
{% endif %}
# License check command:
# scontrol show license
{% endblock execution %}
# To replicate this:
# jobberapp.starccm {{ data.scriptout }}
{%- for key in data.answers %} -p {{key}}={{data[key]}}{% endfor %}